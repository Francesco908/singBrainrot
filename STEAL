-- Auto Farm script per BrainRot (LocalScript)
-- Posiziona questo script in StarterGui come LocalScript

-- SERVICES
local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- PLAYER E CHARACTER
local player = Players.LocalPlayer
if not player then
    warn("Player non trovato! Assicurati che sia un LocalScript in StarterGui.")
    return
end

-- Variabili di gioco
local root, humanoid
local autoFarmEnabled = false
local farmConnection

-- Funzione di setup del Character
local function onCharacterAdded(character)
    -- Attendo root e humanoid
    local hrp = character:WaitForChild("HumanoidRootPart", 10)
    local hmd = character:WaitForChild("Humanoid", 10)
    if hrp and hmd then
        root = hrp
        humanoid = hmd
        print("[AutoFarm] Character caricato correttamente.")
    else
        warn("[AutoFarm] Impossibile ottenere HumanoidRootPart o Humanoid.")
    end
end

-- Connetto l’evento CharacterAdded
player.CharacterAdded:Connect(onCharacterAdded)
-- Se il Character è già pronto, lo setto subito
if player.Character then
    onCharacterAdded(player.Character)
end

-- GUI CREATION
local playerGui = player:WaitForChild("PlayerGui", 10)
if not playerGui then
    warn("PlayerGui non trovato!")
    return
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFarmGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Name = "AutoFarmFrame"
frame.Size = UDim2.new(0, 180, 0, 70)
frame.Position = UDim2.new(0.05, 0, 0.5, -35)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = frame

-- Pulsante Toggle
local toggleBtn = Instance.new("TextButton")
toggleBtn.Name = "ToggleButton"
toggleBtn.Size = UDim2.new(1, -20, 0, 35)
toggleBtn.Position = UDim2.new(0, 10, 0, 10)
toggleBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextSize = 14
toggleBtn.Text = "Auto Farm: OFF"
toggleBtn.BorderSizePixel = 0
toggleBtn.Parent = frame

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 4)
toggleCorner.Parent = toggleBtn

-- Pulsante Close
local closeBtn = Instance.new("TextButton")
closeBtn.Name = "CloseButton"
closeBtn.Size = UDim2.new(0, 20, 0, 20)
closeBtn.Position = UDim2.new(1, -25, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 12
closeBtn.Text = "X"
closeBtn.BorderSizePixel = 0
closeBtn.Parent = frame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeBtn

-- FUNZIONI UTILI
local function getNearestItems()
    if not root then return {} end
    local items = {}
    local maxDistance = 1000
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name == "Item" then
            local dist = (root.Position - obj.Position).Magnitude
            if dist <= maxDistance then
                table.insert(items, {part = obj, distance = dist})
            end
        end
    end
    table.sort(items, function(a, b) return a.distance < b.distance end)
    local result = {}
    for _, entry in ipairs(items) do
        table.insert(result, entry.part)
    end
    return result
end

local function teleportToItem(item)
    if not root or not item or not item.Parent then return end
    local success, err = pcall(function()
        root.CFrame = CFrame.new(item.Position + Vector3.new(0, 5, 0))
    end)
    if not success then
        warn("[AutoFarm] Errore teletrasporto:", err)
    end
end

local function startAutoFarm()
    if farmConnection then return end
    print("[AutoFarm] Avvio auto farm...")
    farmConnection = RunService.Heartbeat:Connect(function()
        if autoFarmEnabled and root then
            local items = getNearestItems()
            if #items > 0 then
                teleportToItem(items[1])
                task.wait(0.1)
            end
        end
    end)
end

local function stopAutoFarm()
    if farmConnection then
        farmConnection:Disconnect()
        farmConnection = nil
        print("[AutoFarm] Auto farm fermato.")
    end
end

-- EVENTI GUI
toggleBtn.MouseButton1Click:Connect(function()
    autoFarmEnabled = not autoFarmEnabled
    if autoFarmEnabled then
        toggleBtn.Text = "Auto Farm: ON"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
        startAutoFarm()
    else
        toggleBtn.Text = "Auto Farm: OFF"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        stopAutoFarm()
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    stopAutoFarm()
    screenGui:Destroy()
    print("[AutoFarm] GUI chiusa.")
end)

Players.PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer == player then
        stopAutoFarm()
    end
end)

print("[AutoFarm] GUI inizializzata. Usa il pulsante per attivare/disattivare.")
